
spark.sql("""select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , mdm_attrib_value_3 as issue_date , mdm_attrib_value_4 as issue_expiration_date , trim(mdm_party_id) as customer_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date   from ALL_ALL_R_GBL_MDM.lnd_cdw_party_n_prof where upper(mdm_attrib_type) in ('BEST_SLN','STATE_LICENSE_CTRL_FLG') and mdm_party_id is not null and mdm_attrib_value is not null
union
select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , mdm_attrib_value_3 as issue_date , mdm_attrib_value_4 as issue_expiration_date , trim(mdm_party_id) as customer_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date   from ALL_ALL_R_GBL_MDM.lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'STATE_CERTIFICATION' and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'
union
select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , mdm_attrib_value_3 as issue_date , mdm_attrib_value_4 as issue_expiration_date , trim(mdm_party_id) as customer_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date   from ALL_ALL_R_GBL_MDM.lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'NPI' and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'
union
select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , mdm_attrib_value_3 as issue_date , mdm_attrib_value_4 as issue_expiration_date , trim(mdm_party_id) as customer_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date   from ALL_ALL_R_GBL_MDM.lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'STATE_LICENSE_ADDL_ATTRIB' and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'
minus
select credential_id, type, value, status, issue_state, issue_country, issue_date, issue_expiration_date, customer_id,mdm_ins_date,mdm_last_mod_date,mdm_eff_end_date from all_all_e_gbl_customer.idl_mdm_credentials
""").createOrReplaceTempView("idl_mdm_credentials")

//below query using fetch insert and update records 

spark.sql("select distinct xref.* from ALL_ALL_R_GBL_MDM.lnd_cdw_party_n_prof xref left anti join idl_mdm_credentials idl on trim(xref.mdm_party_id)=trim(idl.customer_id) and  xref.MDM_PARTY_ID is not null union all  select distinct xref.* from ALL_ALL_R_GBL_MDM.lnd_cdw_party_n_prof xref join idl_mdm_credentials idl on trim(xref.mdm_party_id)=trim(idl.customer_id) ").createOrReplaceTempView("lnd_cdw_party_n_prof")



spark.sql("""INSERT into ALL_ALL_R_GBL_MDM.stg_mdm_credentials select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , mdm_attrib_value_3 as issue_date , mdm_attrib_value_4 as issue_expiration_date , trim(mdm_party_id) as customer_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date , current_timestamp as rec_insert_date , '1022' batch_id , 'MDM' as rec_insert_by , null as reject_reason , 'Y' as status_flag,null as controlflag  from lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'STATE_LICENSE_ADDL_ATTRIB' and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'  union all select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , null as issue_date , mdm_eff_end_dt as issue_expiration_date , trim(mdm_party_id)  mdm_party_id, mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date , current_timestamp as rec_insert_date , '1022' batch_id , 'MDM' as rec_insert_by , null as reject_reason , 'Y' as status_flag,null as controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'STATE_CERTIFICATION' and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'  union all select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , null as issue_date , null as issue_expiration_date , trim(mdm_party_id) mdm_party_id, mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date , current_timestamp as rec_insert_date , '1022' batch_id , 'MDM' as rec_insert_by , null as reject_reason , 'Y' as status_flag,mdm_attrib_value_4 as controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) in ('BEST_SLN','STATE_LICENSE_CTRL_FLG') and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'  union all select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , mdm_attrib_value_3 as issue_date , mdm_attrib_value_4 as issue_expiration_date , trim(mdm_party_id) mdm_party_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date , current_timestamp as rec_insert_date , '1022' batch_id , 'MDM' as rec_insert_by , 'BAD RECORD: NO MDM PARTY ID' as reject_reason , 'E' as status_flag,null as controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'STATE_LICENSE_ADDL_ATTRIB' and mdm_party_id is null and mdm_attrib_value is not null and mdm_attrib_value!='null'  union all select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , null as issue_date , mdm_eff_end_dt as issue_expiration_date , trim(mdm_party_id) mdm_party_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date , current_timestamp as rec_insert_date , '1022' batch_id , 'MDM' as rec_insert_by , 'BAD RECORD: NO MDM PARTY ID' as reject_reason , 'E' as status_flag,null as controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'STATE_CERTIFICATION' and mdm_party_id is null and mdm_attrib_value is not null and mdm_attrib_value!='null'  union all select null as credential_id , mdm_attrib_type as type , mdm_attrib_value as value , mdm_status_cd as status , mdm_attrib_value_2 as issue_state , null as issue_country , null as issue_date , null as issue_expiration_date , trim(mdm_party_id) mdm_party_id , mdm_ins_dt as mdm_ins_date , mdm_last_mod_dt as mdm_last_mod_date , mdm_eff_end_dt as mdm_eff_end_date , current_timestamp as rec_insert_date , '1022' batch_id , 'MDM' as rec_insert_by , 'BAD RECORD: NO MDM PARTY ID' as reject_reason , 'E' as status_flag,mdm_attrib_value_4 as controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) in ('BEST_SLN','STATE_LICENSE_CTRL_FLG') and mdm_party_id is null and mdm_attrib_value is not null and mdm_attrib_value !='null'  union all SELECT null credential_id,         'NPI' type, MDM_ATTRIB_VALUE value,          MDM_STATUS_CD status,        'N/A' issue_state,           null issue_country, null issue_date, null issue_expiration_date, MDM_PARTY_ID customer_id, MDM_INS_DT mdm_ins_date, MDM_LAST_MOD_DT mdm_last_mod_date, MDM_EFF_END_DT mdm_eff_end_date, current_timestamp() rec_insert_date, '1022' batch_id, 'MDM' rec_insert_by, null reject_reason, 'Y' status_flag, null controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'NPI' and mdm_party_id is not null and mdm_attrib_value is not null and mdm_attrib_value!='null'  union all SELECT null credential_id,'NPI' type, MDM_ATTRIB_VALUE value,MDM_STATUS_CD status,'N/A' issue_state,null issue_country, null issue_date, null issue_expiration_date, MDM_PARTY_ID customer_id, MDM_INS_DT mdm_ins_date, MDM_LAST_MOD_DT mdm_last_mod_date, MDM_EFF_END_DT mdm_eff_end_date, current_timestamp rec_insert_date, '1022' batch_id, 'MDM' rec_insert_by, 'BAD RECORD: NO MDM PARTY ID' reject_reason, 'E' status_flag, null controlflag from lnd_cdw_party_n_prof where upper(mdm_attrib_type) = 'NPI' and mdm_party_id is null and mdm_attrib_value is not null and mdm_attrib_value!='null' """)
 